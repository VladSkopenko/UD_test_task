# Питання та рішення по аукціонному сервісу

Документ для поступового продумування вимог. Питання розбираємо по одному, відповіді фіксуємо тут.

**Часові зони:** Усі дати й час у системі зберігаємо та обробляємо **тільки в UTC** (не локальний час, не "naive" datetime). У БД — `TIMESTAMP WITH TIME ZONE` або еквівалент; у коді — `datetime` з timezone (UTC).

---

## 1. Час лота та дедлайн

**Питання:** Чи має лот фіксований час закінчення (`end_time`), чи просто статус `running` без дедлайну?

**Варіанти:**
- A) Лот має `end_time` — після цього часу лот автоматично переходить у `ended`.
- B) Лот без дедлайну — завершується тільки вручну (наприклад, адмін виставляє `ended`).

**Відповідь:**  
Лот має `end_time`. **Стартова тривалість лота — 5 хвилин**: при створенні лота `end_time = now_utc() + 5 хв`. Після цього часу лот автоматично переходить у `ended`. Час завжди в **UTC**.

---

## 2. Продовження часу при ставці

**Питання:** Як саме працює "продовження часу"? На скільки продовжувати і чи є обмеження?

**Варіанти:**
- Кожна нова ставка додає N хвилин до `end_time`.
- Або: якщо ставка в останні M хвилин — додаємо ще K хвилин (правило "останніх хвилин").
- Максимальний час лота (наприклад, не пізніше певного моменту)?

**Відповідь:**  
Кожна нова ставка **продовжує час на 1 хвилину**: `end_time = max(end_time, now_utc()) + 1 хв`. Усі обчислення часу — в **UTC**. Максимальний час лота не обмежуємо.

---

## 3. Крок ставки та хто може ставити

**Питання:**
- Чи є мінімальний крок ставки (наприклад, наступна ставка щонайменше +10 від поточної)?
- Чи один учасник може робити кілька ставок підряд (перебивати сам себе), чи тільки перебивати інших?

**Відповідь:**  
- **Перебивати тільки інших:** учасник не може ставити підряд за собою — наступну ставку може зробити лише інший учасник (поточна максимальна ставка має бути не від цього ж bidder).
- **Мінімум підвищення — 10% від попередньої ставки:** нова ставка має бути не менше ніж `попередня_макс_ставка * 1.10` (округлення — за потреби визначимо, наприклад до 2 знаків після коми або до цілих).

---

## 4. Поля при створенні лота (POST /lots)

**Питання:** Які поля обов'язкові/опційні при створенні лота?

**Приклад полів:**
- назва, опис;
- стартова ціна;
- час початку / час закінчення (якщо є дедлайн);
- тривалість продовження при ставці (хвилини/секунди);
- статус при створенні (завжди `running`?).

**Відповідь:**  
- **Обов'язково:** `title` (назва) — рядок; `starting_price` (стартова ціна) — число > 0; `currency` (валюта) — код, напр. `UAH`, `USD`.
- **Опційно:** `description` (опис) — рядок.
- **На бекенді:** `end_time = now_utc() + 5 хв`, продовження при ставці = 1 хв (фіксовано), `status` при створенні завжди `running`. Клієнт цих полів не передає.

---

## 5. Список лотів GET /lots

**Питання:**
- "Активні" = тільки `status=running`, чи ще й перевірка `end_time > now()`?
- Потрібна пагінація (limit/offset або cursor)?

**Відповідь:**  
- **Пагінація:** `limit` та `offset` (наприклад, за замовчуванням `limit=20`, `offset=0`).
- **Фільтри (query-параметри):**
  - **Ціна:** `min_price`, `max_price` — по стартовій ціні лота. Можна передати тільки один (наприклад, «від 100» або «до 500») або обидва — діапазон від і до.
  - **Назва:** `title` — пошук по назві (substring, без урахування регістру).
  - **Валюта:** `currency` — точний збіг (код валюти лота).
  - **Статус:** `status` — `running` | `ended`; якщо не передано — показувати тільки активні (`status=running` і `end_time > now_utc()`).
- За потреби: "активні" = `status=running` **і** `end_time > now_utc()` (прострочені не показувати в списку "активних").

---

## 6. Авторизація при ставці (POST /lots/{id}/bids)

**Питання:** Хто робить ставку — з ідентифікатором користувача (JWT, API key) чи для тестового завдання достатньо передавати, наприклад, `bidder_name` в тілі?

**Відповідь:**  
Без JWT/API key. У тілі запиту передаємо **`bidder_id`** (унікальний ідентифікатор учасника, напр. UUID або число) та **`bidder_name`** (назва/ім'я для відображення). Цього достатньо для перевірки «не перебивати себе» та для відображення в подіях WebSocket.

---

## 7. WebSocket — що відправляти при підключенні

**Питання:** Клієнт підключається до `/ws/lots/{lot_id}`. Відразу слати поточний стан лота (поточна ціна, `end_time`, останні ставки) чи тільки події після підключення?

**Відповідь:**  
По WebSocket слати **тільки нові події** (нова ставка, продовження часу, лот завершено). Історію та поточний стан клієнт отримує через **REST**: окремий ендпоінт для лота з історією ставок (наприклад, GET `/lots/{lot_id}` або GET `/lots/{lot_id}/bids` — повертає лот + список ставок). Підключившись до сокета, клієнт лише отримує події в реальному часі.

---

## 8. WebSocket — які події слати

**Питання:** Які типи подій відправляти клієнтам?
- нова ставка (ціна, хто, час);
- продовження часу (новий `end_time`);
- лот завершено (`ended`)?

**Відповідь:**  
По WebSocket слати два типи подій: **(1) нова ставка** — ціна, bidder_id/bidder_name, час (UTC); **(2) подовження часу** — новий `end_time` (UTC). При завершенні лота — подія **лот завершено** (`status: ended`).

---

## 9. Міграції БД

**Питання:** Використовувати Alembic (міграції) чи для MVP достатньо створити таблиці при старті (наприклад, через SQLAlchemy `create_all`)?

**Відповідь:**  
Використовуємо **Alembic**: у проєкті вже є структура `migrations/`. Це дає версійність схеми та зручний деплой.

---

## 10. Docker

**Питання:**
- Достатньо `docker-compose` (додаток + PostgreSQL)?
- Потрібен окремий Dockerfile з multi-stage build чи простий варіант?

**Відповідь:**  
**docker-compose** з двома сервісами: додаток (FastAPI) та PostgreSQL. Окремий **Dockerfile** для бекенду — простий варіант (один stage), без multi-stage.

---

## 11. Автоматичне завершення лота по часу

**Питання:** Як переводити лот у `ended`, коли настав `end_time`?
- Фонова задача/періодична перевірка (наприклад, кожні N секунд);
- Перевірка при кожній ставці або при запиті до лота;
- Інший варіант.

**Відповідь:**  
**Фонова задача** кожні **30 секунд**: перевіряємо всі лоти з `status=running` і `end_time < now_utc()` — оновлюємо їх на `status=ended`. Підписникам WebSocket по цих лотах відправляємо подію «лот завершено». Так лоти гарантовано закриваються вчасно, навіть якщо немає запитів.

---

## 12. Валідація ставки

**Питання:** Ставка має бути строго більшою за поточну максимальну ціну? Чи є ще правила (мінімальний крок, не можна ставити на свій лот тощо)?

**Відповідь:**  
Так, див. питання 3: **(1)** ставка строго більша за поточну макс. ціну; **(2)** мінімум +10% від неї; **(3)** не може ставити той самий учасник, що й поточна максимальна ставка (не перебивати себе).

---

_Після заповнення всіх відповідей цей документ стане специфікацією для реалізації._
